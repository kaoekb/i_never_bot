# # .gitlab-ci.yml
# stages:
#   - build
#   - deploy

# variables:
#   DOCKER_IMAGE: registry.gitlab.com/i_never_bot/i_never_bot

# build:
#   stage: build
#   script:
#     - docker build -t $DOCKER_IMAGE .
#     - docker push $DOCKER_IMAGE
#   only:
#     - main

# deploy:
#   stage: deploy
#   script:
#     - docker-compose down
#     - docker-compose pull
#     - docker-compose up -d
#   only:
#     - main

# stages:
#   - build
#   - deploy

# build-job:
#   stage: build
#   script:
#     - docker build -t i_never_bot .


# deploy-job:
#   stage: deploy
#   script:
#     - docker-compose down || true
#     - docker-compose up -d

image: docker:latest

services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay2

stages:
  - cleanup
  - build
  - deploy

cleanup-old-images:
  stage: cleanup
  script:
    - echo "üßπ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã i_never_bot..."
    - docker image prune -f || true
    - docker rmi $(docker images "i_never_bot" --format "{{.ID}}" | tail -n +2) || true
  only:
    - main

build-job:
  stage: build
  script:
    - echo "üîß –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑..."
    - docker build -t i_never_bot .

deploy-job:
  stage: deploy
  script:
    - echo "üöÄ –î–µ–ø–ª–æ–π..."
    - docker-compose down || true
    - docker-compose up -d
